@model List<FP.Models.Transaction>
@{
    ViewData["Title"] = "Transactions";
    Layout = "_Layout2";
}

<style>
    .cat-mascot {
        position: absolute;
        top: -50px;
        right: 150px;
        width: 180px;
        height: 180px;
        z-index: 1000;
        transform: rotate(180deg);
        animation: catSlideToAddNew 2s ease-out;
        filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
        transition: transform 0.3s ease;
        object-fit: contain;
    }
    
    .cat-mascot:hover {
        transform: rotate(180deg) scale(1.1);
    }
    
    @@keyframes catSlideToAddNew {
        0% { 
            top: -280px;
            opacity: 0;
        }
        20% {
            opacity: 1;
        }
        100% { 
            top: -50px;
            opacity: 1;
        }
    }
</style>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            showSuccessPopup('@TempData["SuccessMessage"]');
        });
        
        function showSuccessPopup(message, customIcon = null) {
            const icon = customIcon || '✅';
            const popupHtml = '<div class="success-popup" style="position: fixed; top: 80px; right: 20px; background: linear-gradient(135deg, #008080, #20C997); color: white; padding: 16px 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 128, 128, 0.3); z-index: 1060; animation: slideInRight 0.4s ease-out; max-width: 350px; cursor: pointer;">' +
                '<div style="display: flex; align-items: center;">' +
                    '<span style="font-size: 20px; margin-right: 12px;">' + icon + '</span>' +
                    '<div>' +
                        '<div style="font-weight: 600; font-size: 14px; margin-bottom: 2px;">Success!</div>' +
                        '<div style="font-size: 13px; opacity: 0.9;">' + message + '</div>' +
                    '</div>' +
                    '<button onclick="this.parentElement.parentElement.remove()" style="margin-left: auto; background: none; border: none; color: white; font-size: 18px; cursor: pointer; opacity: 0.8;">×</button>' +
                '</div>' +
            '</div>' +
            '<style>' +
                '@@keyframes slideInRight {' +
                    'from { transform: translateX(100%); opacity: 0; }' +
                    'to { transform: translateX(0); opacity: 1; }' +
                '}' +
                '.success-popup:hover { transform: scale(1.02); transition: transform 0.2s; }' +
            '</style>';
            
            document.body.insertAdjacentHTML('beforeend', popupHtml);
            
            // Auto-remove after 4 seconds
            setTimeout(function() {
                const popup = document.querySelector('.success-popup');
                if (popup) {
                    popup.style.animation = 'slideInRight 0.3s ease-out reverse';
                    setTimeout(function() { popup.remove(); }, 300);
                }
            }, 4000);
        }
    </script>
}

@section Styles {
    <style>
        h2 {
            color: #008080 !important;
            font-weight: 700;
        }
        
        .btn-primary {
            background-color: #008080 !important;
            border-color: #008080 !important;
        }
        
        .btn-primary:hover {
            background-color: #006666 !important;
            border-color: #006666 !important;
        }
        
        .btn-outline-danger {
            padding: 4px 12px;
            font-size: 0.875rem;
        }

        .filter-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .income-amount {
            color: #10B981;
            font-weight: 600;
        }

        .expense-amount {
            color: #008080;
            font-weight: 600;
        }

        .badge-income {
            background-color: #10B981;
        }

        .badge-expense {
            background-color: #008080;
        }
    </style>
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Transactions</h2>
    <a asp-controller="Transaction" asp-action="Add" class="btn btn-primary">Add New</a>
</div>

<!-- Debug Information -->
@if (ViewBag.NoTransactions == true)
{
    <div class="alert alert-warning">
        <strong>No transactions found in database.</strong> Please add some transactions first.
    </div>
}
else if (ViewBag.TotalTransactions != null)
{
    <div class="alert alert-info">
        <strong>Total transactions in database:</strong> @ViewBag.TotalTransactions
    </div>
}

<!-- Filters -->
<div class="card filter-section mb-4">
    <form method="get" asp-action="List">
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Type</label>
                <select name="type" class="form-select">
                    <option value="">All Types</option>
                    @{
                        var selectedType = ViewBag.Type as string;
                        var incomeSelected = selectedType == "income" ? "selected" : "";
                        var expenseSelected = selectedType == "expense" ? "selected" : "";
                    }
                    <option value="income" selected="@incomeSelected">Income</option>
                    <option value="expense" selected="@expenseSelected">Expense</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Category</label>
                <select name="category" class="form-select">
                    <option value="">All Categories</option>
                    @if (ViewBag.Categories != null)
                    {
                        var categories = ViewBag.Categories as List<string> ?? new List<string>();
                        var selectedCategory = ViewBag.Category as string;
                        
                        @foreach (var cat in categories)
                        {
                            var isSelected = selectedCategory == cat ? "selected" : "";
                            <option value="@cat" selected="@isSelected">@cat</option>
                        }
                    }
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">From Date</label>
                <input type="date" name="fromDate" value="@ViewBag.FromDate" class="form-control">
            </div>
            <div class="col-md-3">
                <label class="form-label">To Date</label>
                <input type="date" name="toDate" value="@ViewBag.ToDate" class="form-control">
            </div>
            <div class="col-12 text-end">
                <button type="submit" class="btn btn-primary">Apply Filters</button>
                <a asp-action="List" class="btn btn-outline-secondary">Clear</a>
            </div>
        </div>
    </form>
</div>

<!-- Transactions Table -->
<div class="card">
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Category</th>
                    <th>Description</th>
                    <th>Amount</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (Model != null && Model.Any())
                {
                    @foreach (var t in Model)
                    {
                        <tr>
                            <td>@t.Date.ToString("yyyy-MM-dd")</td>
                            <td>
                                <span class="badge @(t.Type.ToLower() == "income" ? "badge-income" : "badge-expense") text-white">
                                    @t.Type
                                </span>
                            </td>
                            <td>@t.Category</td>
                            <td>@(string.IsNullOrEmpty(t.Description) ? "-" : t.Description)</td>
                            <td class="@(t.Type.ToLower() == "income" ? "income-amount" : "expense-amount")">
                                @(t.Type.ToLower() == "income" ? "+" : "-")$@t.Amount.ToString("N2")
                            </td>
                            <td>
                                <form asp-action="Delete" asp-controller="Transaction" method="post" style="display: inline;">
                                    <input type="hidden" name="id" value="@t.Id" />
                                    <button type="submit" class="btn btn-outline-danger btn-sm" 
                                            onclick="return showDeleteConfirmation();">Delete</button>
                                </form>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="6" class="text-center text-muted">No transactions found. <a asp-action="Add">Add your first transaction</a></td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Custom Confirmation Dialog -->
<div id="deleteConfirmDialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-width: 400px; text-align: center;">
        <h4 style="color: #008080; margin-bottom: 15px;">Confirm Delete</h4>
        <p style="margin-bottom: 25px; color: #666;">Are you sure you want to delete this transaction?</p>
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button onclick="cancelDelete()" style="padding: 8px 20px; border: 1px solid #ccc; background: white; border-radius: 6px; cursor: pointer;">Cancel</button>
            <button onclick="confirmDelete()" style="padding: 8px 20px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer;">Yes</button>
        </div>
    </div>
</div>

<script>
    let deleteForm = null;
    
    function showDeleteConfirmation() {
        document.getElementById('deleteConfirmDialog').style.display = 'flex';
        deleteForm = event.target.form;
        return false;
    }
    
    function confirmDelete() {
        document.getElementById('deleteConfirmDialog').style.display = 'none';
        if (deleteForm) {
            deleteForm.submit();
        }
    }
    
    function cancelDelete() {
        document.getElementById('deleteConfirmDialog').style.display = 'none';
        deleteForm = null;
    }
</script>

<img src="/images/cuteCat.png" alt="Cat Mascot" class="cat-mascot" />
